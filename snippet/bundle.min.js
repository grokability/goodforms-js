(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=global||self,global.Goodverification=factory())})(this,function(){"use strict";var HOST="http://localhost:8000";var Log=function Log(debug_enabled){if(debug_enabled===void 0)debug_enabled=false;this.debug_enabled=debug_enabled};Log.prototype.error=function error(msg){if(!this.log_at_level("error",msg)){window.alert("Error: "+msg)}};Log.prototype.debug=function debug(msg){if(this.debug_enabled){this.log_at_level("debug",msg)}};Log.prototype.log_at_level=function log_at_level(level,msg){if(console&&console[level]){console[level](msg);return true}return false};var log=new Log;function duplicate(obj){var newobj={};for(var i in obj){newobj[i]=obj[i]}return newobj}function is_array(obj){if(Object.prototype.toString.call(obj)=="[object Array]"){return true}return false}var commonjsGlobal=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var jsonp=createCommonjsModule(function(module){(function(){var JSONP,computedUrl,createElement,encode,noop,objectToURI,random,randomString;createElement=function(tag){return window.document.createElement(tag)};encode=window.encodeURIComponent;random=Math.random;JSONP=function(options){var callback,callbackFunc,callbackName,done,head,params,script;if(options==null){options={}}params={data:options.data||{},error:options.error||noop,success:options.success||noop,beforeSend:options.beforeSend||noop,complete:options.complete||noop,url:options.url||""};params.computedUrl=computedUrl(params);if(params.url.length===0){throw new Error("MissingUrl")}done=false;if(params.beforeSend({},params)!==false){callbackName=options.callbackName||"callback";callbackFunc=options.callbackFunc||"jsonp_"+randomString(15);callback=params.data[callbackName]=callbackFunc;window[callback]=function(data){window[callback]=null;params.success(data,params);return params.complete(data,params)};script=createElement("script");script.src=computedUrl(params);script.async=true;script.onerror=function(evt){params.error({url:script.src,event:evt});return params.complete({url:script.src,event:evt},params)};script.onload=script.onreadystatechange=function(){var ref,ref1;if(done||(ref=this.readyState)!=="loaded"&&ref!=="complete"){return}done=true;if(script){script.onload=script.onreadystatechange=null;if((ref1=script.parentNode)!=null){ref1.removeChild(script)}return script=null}};head=window.document.getElementsByTagName("head")[0]||window.document.documentElement;head.insertBefore(script,head.firstChild)}return{abort:function(){window[callback]=function(){return window[callback]=null};done=true;if(script!=null?script.parentNode:void 0){script.onload=script.onreadystatechange=null;script.parentNode.removeChild(script);return script=null}}}};noop=function(){return void 0};computedUrl=function(params){var url;url=params.url;url+=params.url.indexOf("?")<0?"?":"&";url+=objectToURI(params.data);return url};randomString=function(length){var str;str="";while(str.length<length){str+=random().toString(36).slice(2,3)}return str};objectToURI=function(obj){var data,key,value;data=function(){var results;results=[];for(key in obj){value=obj[key];results.push(encode(key)+"="+encode(value))}return results}();return data.join("&")};if(module!==null?module.exports:void 0){module.exports=JSONP}else{this.JSONP=JSONP}}).call(commonjsGlobal)});var tingle_min=createCommonjsModule(function(module,exports){!function(t,o){module.exports=o()}(commonjsGlobal,function(){function t(t){var o={onClose:null,onOpen:null,beforeOpen:null,beforeClose:null,stickyFooter:!1,footer:!1,cssClass:[],closeLabel:"Close",closeMethods:["overlay","button","escape"]};this.opts=r({},o,t),this.init()}function o(){return'<svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg"><path d="M.3 9.7c.2.2.4.3.7.3.3 0 .5-.1.7-.3L5 6.4l3.3 3.3c.2.2.5.3.7.3.2 0 .5-.1.7-.3.4-.4.4-1 0-1.4L6.4 5l3.3-3.3c.4-.4.4-1 0-1.4-.4-.4-1-.4-1.4 0L5 3.6 1.7.3C1.3-.1.7-.1.3.3c-.4.4-.4 1 0 1.4L3.6 5 .3 8.3c-.4.4-.4 1 0 1.4z" fill="#000" fill-rule="nonzero"/></svg>'}function e(){this.modalBoxFooter&&(this.modalBoxFooter.style.width=this.modalBox.clientWidth+"px",this.modalBoxFooter.style.left=this.modalBox.offsetLeft+"px")}function s(){this.modal=document.createElement("div"),this.modal.classList.add("tingle-modal"),0!==this.opts.closeMethods.length&&-1!==this.opts.closeMethods.indexOf("overlay")||this.modal.classList.add("tingle-modal--noOverlayClose"),this.modal.style.display="none",this.opts.cssClass.forEach(function(t){"string"==typeof t&&this.modal.classList.add(t)},this),-1!==this.opts.closeMethods.indexOf("button")&&(this.modalCloseBtn=document.createElement("button"),this.modalCloseBtn.type="button",this.modalCloseBtn.classList.add("tingle-modal__close"),this.modalCloseBtnIcon=document.createElement("span"),this.modalCloseBtnIcon.classList.add("tingle-modal__closeIcon"),this.modalCloseBtnIcon.innerHTML=o(),this.modalCloseBtnLabel=document.createElement("span"),this.modalCloseBtnLabel.classList.add("tingle-modal__closeLabel"),this.modalCloseBtnLabel.innerHTML=this.opts.closeLabel,this.modalCloseBtn.appendChild(this.modalCloseBtnIcon),this.modalCloseBtn.appendChild(this.modalCloseBtnLabel)),this.modalBox=document.createElement("div"),this.modalBox.classList.add("tingle-modal-box"),this.modalBoxContent=document.createElement("div"),this.modalBoxContent.classList.add("tingle-modal-box__content"),this.modalBox.appendChild(this.modalBoxContent),-1!==this.opts.closeMethods.indexOf("button")&&this.modal.appendChild(this.modalCloseBtn),this.modal.appendChild(this.modalBox)}function i(){this.modalBoxFooter=document.createElement("div"),this.modalBoxFooter.classList.add("tingle-modal-box__footer"),this.modalBox.appendChild(this.modalBoxFooter)}function n(){this._events={clickCloseBtn:this.close.bind(this),clickOverlay:d.bind(this),resize:this.checkOverflow.bind(this),keyboardNav:l.bind(this)},-1!==this.opts.closeMethods.indexOf("button")&&this.modalCloseBtn.addEventListener("click",this._events.clickCloseBtn),this.modal.addEventListener("mousedown",this._events.clickOverlay),window.addEventListener("resize",this._events.resize),document.addEventListener("keydown",this._events.keyboardNav)}function l(t){-1!==this.opts.closeMethods.indexOf("escape")&&27===t.which&&this.isOpen()&&this.close()}function d(t){-1!==this.opts.closeMethods.indexOf("overlay")&&!a(t.target,"tingle-modal")&&t.clientX<this.modal.clientWidth&&this.close()}function a(t,o){for(;(t=t.parentElement)&&!t.classList.contains(o);){}return t}function h(){-1!==this.opts.closeMethods.indexOf("button")&&this.modalCloseBtn.removeEventListener("click",this._events.clickCloseBtn),this.modal.removeEventListener("mousedown",this._events.clickOverlay),window.removeEventListener("resize",this._events.resize),document.removeEventListener("keydown",this._events.keyboardNav)}function r(){var arguments$1=arguments;for(var t=1;t<arguments.length;t++){for(var o in arguments[t]){arguments$1[t].hasOwnProperty(o)&&(arguments$1[0][o]=arguments$1[t][o])}}return arguments[0]}var c=!1;return t.prototype.init=function(){if(!this.modal){return s.call(this),n.call(this),document.body.insertBefore(this.modal,document.body.firstChild),this.opts.footer&&this.addFooter(),this}},t.prototype._busy=function(t){c=t},t.prototype._isBusy=function(){return c},t.prototype.destroy=function(){null!==this.modal&&(this.isOpen()&&this.close(!0),h.call(this),this.modal.parentNode.removeChild(this.modal),this.modal=null)},t.prototype.isOpen=function(){return!!this.modal.classList.contains("tingle-modal--visible")},t.prototype.open=function(){if(!this._isBusy()){this._busy(!0);var t=this;return"function"==typeof t.opts.beforeOpen&&t.opts.beforeOpen(),this.modal.style.removeProperty?this.modal.style.removeProperty("display"):this.modal.style.removeAttribute("display"),this._scrollPosition=window.pageYOffset,document.body.classList.add("tingle-enabled"),document.body.style.top=-this._scrollPosition+"px",this.setStickyFooter(this.opts.stickyFooter),this.modal.classList.add("tingle-modal--visible"),"function"==typeof t.opts.onOpen&&t.opts.onOpen.call(t),t._busy(!1),this.checkOverflow(),this}},t.prototype.close=function(t){if(!this._isBusy()){if(this._busy(!0),"function"==typeof this.opts.beforeClose){if(!this.opts.beforeClose.call(this)){return void this._busy(!1)}}document.body.classList.remove("tingle-enabled"),window.scrollTo(0,this._scrollPosition),document.body.style.top=null,this.modal.classList.remove("tingle-modal--visible");var o=this;o.modal.style.display="none","function"==typeof o.opts.onClose&&o.opts.onClose.call(this),o._busy(!1)}},t.prototype.setContent=function(t){return"string"==typeof t?this.modalBoxContent.innerHTML=t:(this.modalBoxContent.innerHTML="",this.modalBoxContent.appendChild(t)),this.isOpen()&&this.checkOverflow(),this},t.prototype.getContent=function(){return this.modalBoxContent},t.prototype.addFooter=function(){return i.call(this),this},t.prototype.setFooterContent=function(t){return this.modalBoxFooter.innerHTML=t,this},t.prototype.getFooterContent=function(){return this.modalBoxFooter},t.prototype.setStickyFooter=function(t){return this.isOverflow()||(t=!1),t?this.modalBox.contains(this.modalBoxFooter)&&(this.modalBox.removeChild(this.modalBoxFooter),this.modal.appendChild(this.modalBoxFooter),this.modalBoxFooter.classList.add("tingle-modal-box__footer--sticky"),e.call(this),this.modalBoxContent.style["padding-bottom"]=this.modalBoxFooter.clientHeight+20+"px"):this.modalBoxFooter&&(this.modalBox.contains(this.modalBoxFooter)||(this.modal.removeChild(this.modalBoxFooter),this.modalBox.appendChild(this.modalBoxFooter),this.modalBoxFooter.style.width="auto",this.modalBoxFooter.style.left="",this.modalBoxContent.style["padding-bottom"]="",this.modalBoxFooter.classList.remove("tingle-modal-box__footer--sticky"))),this},t.prototype.addFooterBtn=function(t,o,e){var s=document.createElement("button");return s.innerHTML=t,s.addEventListener("click",e),"string"==typeof o&&o.length&&o.split(" ").forEach(function(t){s.classList.add(t)}),this.modalBoxFooter.appendChild(s),s},t.prototype.resize=function(){console.warn("Resize is deprecated and will be removed in version 1.0")},t.prototype.isOverflow=function(){var t=window.innerHeight;return this.modalBox.clientHeight>=t},t.prototype.checkOverflow=function(){this.modal.classList.contains("tingle-modal--visible")&&(this.isOverflow()?this.modal.classList.add("tingle-modal--overflow"):this.modal.classList.remove("tingle-modal--overflow"),!this.isOverflow()&&this.opts.stickyFooter?this.setStickyFooter(!1):this.isOverflow()&&this.opts.stickyFooter&&(e.call(this),this.setStickyFooter(!0)))},{modal:t}})});function styleInject(css,ref){if(ref===void 0){ref={}}var insertAt=ref.insertAt;if(!css||typeof document==="undefined"){return}var head=document.head||document.getElementsByTagName("head")[0];var style=document.createElement("style");style.type="text/css";if(insertAt==="top"){if(head.firstChild){head.insertBefore(style,head.firstChild)}else{head.appendChild(style)}}else{head.appendChild(style)}if(style.styleSheet){style.styleSheet.cssText=css}else{style.appendChild(document.createTextNode(css))}}var css='.tingle-modal *{box-sizing:border-box}.tingle-modal{position:fixed;top:0;right:0;bottom:0;left:0;z-index:1000;display:-ms-flexbox;display:flex;visibility:hidden;-ms-flex-direction:column;flex-direction:column;-ms-flex-align:center;align-items:center;overflow:hidden;-webkit-overflow-scrolling:touch;background:rgba(0,0,0,.85);opacity:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer}.tingle-modal--noClose .tingle-modal__close,.tingle-modal__closeLabel{display:none}.tingle-modal--confirm .tingle-modal-box{text-align:center}.tingle-modal--noOverlayClose{cursor:default}.tingle-modal__close{position:fixed;top:2rem;right:2rem;z-index:1000;padding:0;width:2rem;height:2rem;border:none;background-color:transparent;color:#fff;cursor:pointer}.tingle-modal__close svg *{fill:currentColor}.tingle-modal__close:hover{color:#fff}.tingle-modal-box{position:relative;-ms-flex-negative:0;flex-shrink:0;margin-top:auto;margin-bottom:auto;width:60%;border-radius:4px;background:#fff;opacity:1;cursor:auto;will-change:transform,opacity}.tingle-modal-box__content{padding:3rem}.tingle-modal-box__footer{padding:1.5rem 2rem;width:auto;border-bottom-right-radius:4px;border-bottom-left-radius:4px;background-color:#f5f5f5;cursor:auto}.tingle-modal-box__footer::after{display:table;clear:both;content:""}.tingle-modal-box__footer--sticky{position:fixed;bottom:-200px;z-index:10001;opacity:1;transition:bottom .3s ease-in-out .3s}.tingle-enabled{position:fixed;right:0;left:0;overflow:hidden}.tingle-modal--visible .tingle-modal-box__footer{bottom:0}.tingle-enabled .tingle-content-wrapper{filter:blur(8px)}.tingle-modal--visible{visibility:visible;opacity:1}.tingle-modal--visible .tingle-modal-box{animation:scale .2s cubic-bezier(.68,-.55,.265,1.55) forwards}.tingle-modal--overflow{overflow-y:scroll;padding-top:8vh}.tingle-btn{display:inline-block;margin:0 .5rem;padding:1rem 2rem;border:none;background-color:grey;box-shadow:none;color:#fff;vertical-align:middle;text-decoration:none;font-size:inherit;font-family:inherit;line-height:normal;cursor:pointer;transition:background-color .4s ease}.tingle-btn--primary{background-color:#3498db}.tingle-btn--danger{background-color:#e74c3c}.tingle-btn--default{background-color:#34495e}.tingle-btn--pull-left{float:left}.tingle-btn--pull-right{float:right}@media (max-width :540px){.tingle-modal{top:0;display:block;padding-top:60px;width:100%}.tingle-modal-box{width:auto;border-radius:0}.tingle-modal-box__content{overflow-y:scroll}.tingle-modal--noClose{top:0}.tingle-modal--noOverlayClose{padding-top:0}.tingle-modal-box__footer .tingle-btn{display:block;float:none;margin-bottom:1rem;width:100%}.tingle-modal__close{top:0;right:0;left:0;display:block;width:100%;height:60px;border:none;background-color:#2c3e50;box-shadow:none;color:#fff}.tingle-modal__closeLabel{display:inline-block;vertical-align:middle;font-size:1.6rem;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif}.tingle-modal__closeIcon{display:inline-block;margin-right:.8rem;width:1.6rem;vertical-align:middle;font-size:0}}@supports ((-webkit-backdrop-filter:blur(12px)) or (backdrop-filter:blur(12px))){.tingle-modal{-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px)}@media (max-width :540px){.tingle-modal{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}}.tingle-enabled .tingle-content-wrapper{filter:none}}@keyframes scale{0%{opacity:0;transform:scale(.9)}100%{opacity:1;transform:scale(1)}}';styleInject(css);var Form=function Form(options){log.debug("Invoking Class constructor!");for(var key in options){log.debug("Setting: "+key+" to "+options[key]);this[key]=options[key]}if(!this.form_key){return log.error("No Form Key set!")}if(this.manual){log.debug("Manual mode selected; exiting setup");return}if(!this.email_field){return log.error("No Email Field set!")}if(!this.form){log.debug("Trying to guess Form value");this.form=this.email_field.form;log.debug("Picked: "+this.form)}if(!this.form){return log.error("Could not determine Form!")}if(!this.submit_button){log.debug("Trying to find submit buttons...");var submit_buttons=[];for(var element in this.form.elements){var this_element=this.form.elements[element];log.debug("Checking element: "+element+" - nodeName: '"+this_element.nodeName+"' Type: '"+this_element.type+"'");if(this_element.nodeName=="INPUT"&&this_element.type=="submit"){log.debug("Found a submit button");submit_buttons.push(this_element)}}this.submit_button=submit_buttons}this.initialize_dom()};Form.prototype.initialize_dom=function initialize_dom(){var this$1=this;var old_onchange=this.email_field.onchange;this.email_field.onchange=function(event){this$1.onchange_handler(event);if(old_onchange){old_onchange(event)}};if(this.form){var old_onsubmit=this.form.onsubmit;this.form.onsubmit=function(event){if(old_onsubmit){var results$1=old_onsubmit(event)}if(results){return this.onsubmit_handler(event)}}}this.disable_submits()};Form.prototype.disable_submits=function disable_submits(){this.set_submit_button_disabled(true)};Form.prototype.enable_submits=function enable_submits(){this.set_submit_button_disabled(false)};Form.prototype.set_submit_button_disabled=function set_submit_button_disabled(state){if(this.submit_button){log.debug("Trying to disable submit button...");if(is_array(this.submit_button)){log.debug("Submit button IS ARRAY");for(var x in this.submit_button){this.submit_button[x].disabled=state}}else{this.submit_button.disabled=state}}};Form.prototype.onchange_handler=function onchange_handler(event){var this$1=this;this.verify(this.email_field.value,function(results){log.debug("Verification results are: "+results);switch(results.status){case"BAD":this$1.mytooltip=new Tooltip(this$1.email_field);this$1.mytooltip.show();this$1.disable_submits();break;case"GOOD":if(this$1.mytooltip){this$1.mytooltip.hide()}this$1.enable_submits();break;case"CHALLENGE":this$1.display_challenge_modal(results.challenge_key);break}})};Form.prototype.display_challenge_modal=function display_challenge_modal(challenge_key){var this$1=this;if(!this.modal){this.modal=new tingle_min.modal({footer:true,stickyFooter:false,closeMethods:["button"],closeLabel:"Close",onOpen:function(){console.log("modal open")},onClose:function(){console.log("modal closed")},beforeClose:function(){return true}});this.modal.addFooterBtn("Cancel","tingle-btn",function(){this$1.modal.close()});this.modal.addFooterBtn("Send Challenge Email","tingle-btn tingle-btn--primary",function(){if(this$1.email_field.value!=document.getElementById("goodverification_challenge_address").value){log.debug("Field value: "+this$1.email_field.value+" , challenge_address: "+document.getElementById("goodverification_challenge_address").value);this$1.modal.setContent("Email doesn't match field on form!");return}this$1.challenge(this$1.email_field.value,challenge_key,function(results){log.debug("Challenge results are: "+results);console.dir(results);if(results.status=="ACCEPTED"){this$1.modal.setContent("Input emailed PIN: <input type='text' id='goodverification_pin' />")}})})}this.modal.setContent("Too many verifications from this IP. We need to send you an email to verify that you are you! "+"If you agree, re-type your email here: <input type='text' id='goodverification_challenge_address' />");this.modal.open()};Form.prototype.onsubmit_handler=function onsubmit_handler(event){DO_SOMETHING_CLEVERER();jsonp("url")};Form.prototype.verify=function verify(email,callback){jsonp({url:HOST+"/verify",data:{email:email,form_key:this.form_key},success:function(data){if(data.error){log.error(data.error)}callback(data)}})};Form.prototype.challenge=function challenge(email,challenge_key,callback){jsonp({url:HOST+"/challenge",data:{email:email,form_key:this.form_key,challenge_key:challenge_key},success:function(data){callback(data)}})};function auto(form_key,options){if(!form_key){log.error("Form key was not set");return}var my_options;if(options){my_options=duplicate(options);my_options.form_key=form_key}else{my_options={form_key:form_key}}if(my_options.debug){log.debug_enabled=my_options.debug;delete my_options.debug}var activated_forms=[];for(var form in document.forms){log.debug("Checking form: "+form+" for verifiable email address fields...");for(var element in document.forms[form].elements){log.debug("Checking field #"+element+" to see if it's an email address field");var this_field=document.forms[form].elements[element];if(this_field.type=="email"||this_field.name=="email"||this_field.id=="email"){var options_copy=duplicate(my_options);log.debug("Found candidate field. Name: "+this_field.name+" Type: "+this_field.type+" ID: "+this_field.id);options_copy.form=document.forms[form];options_copy.email_field=this_field;activated_forms.push(new Form(options_copy))}}}return activated_forms}function index(form_key,options){if(options&&options.debug){log.debug_enabled=options.debug}if(!form_key){log.error("Form key was not set")}if(!options||!options.email_field&&!options.manual){return auto(form_key,options)}return new Form(form_key,options)}return index});